# 真实API配置指南

## 概述

已成功移除模拟数据，现在使用真实的火山引擎方舟API进行AI识别。所有错误都会被详细记录以便调试。

## 配置步骤

### 1. 获取火山引擎方舟API配置

#### 登录火山引擎控制台
1. 访问 [火山引擎控制台](https://console.volcengine.com/)
2. 登录您的账号

#### 创建方舟推理接入点
1. 进入"机器学习平台" > "方舟"
2. 选择"推理接入点"
3. 点击"创建推理接入点"
4. 选择适合的模型（推荐使用多模态模型）
5. 记录下推理接入点ID（格式：`ep-xxxxxxxx-xxxxxx`）

#### 获取API Key
1. 在方舟控制台找到"API密钥管理"
2. 创建新的API Key
3. 记录下API Key（格式：`xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`）

### 2. 更新云函数配置

编辑 `cloudfunctions/aiRecognition/index.js` 文件中的配置：

```javascript
const AI_CONFIG = {
  apiKey: 'your-actual-api-key-here', // 替换为您的实际API Key
  model: 'ep-your-actual-model-id', // 替换为您的实际推理接入点ID
  baseUrl: 'https://ark.cn-beijing.volces.com/api/v3',
  timeout: 30000,
  retryCount: 2
};
```

### 3. 部署云函数

```bash
# 在项目根目录执行
cd cloudfunctions/aiRecognition
npm install
cd ../..
# 使用微信开发者工具上传并部署云函数
```

## 错误记录说明

### 云函数端错误记录

所有错误都会在云函数日志中详细记录：

1. **参数验证错误**
   - 缺少图片数据
   - 图片格式不支持

2. **API调用错误**
   - 网络连接失败
   - API认证失败
   - 请求超时
   - 服务器错误

3. **响应解析错误**
   - JSON格式错误
   - 必要字段缺失
   - 数据类型错误

### 客户端错误记录

所有错误都会在客户端控制台详细记录：

1. **图片处理错误**
   - 图片读取失败
   - 格式转换失败

2. **云函数调用错误**
   - 网络连接失败
   - 云函数执行失败
   - 返回数据格式错误

## 调试方法

### 查看云函数日志

1. 打开微信开发者工具
2. 进入"云开发"控制台
3. 选择"云函数"
4. 找到 `aiRecognition` 函数
5. 点击"日志"查看详细执行日志

### 查看客户端日志

1. 在微信开发者工具中打开"调试器"
2. 查看"Console"面板
3. 所有AI识别相关的日志都会以 `===` 标记

### 常见错误及解决方案

#### 1. API Key无效
```
错误: API请求失败: 401 - Unauthorized
解决: 检查API Key是否正确，是否已激活
```

#### 2. 模型ID无效
```
错误: API请求失败: 404 - Model not found
解决: 检查推理接入点ID是否正确
```

#### 3. 图片格式不支持
```
错误: 图片读取失败: file not found
解决: 确保图片路径正确，格式为jpg/png
```

#### 4. 网络连接失败
```
错误: 云函数调用失败: network error
解决: 检查网络连接，重试请求
```

## 性能监控

### 响应时间监控
- 图片转换时间
- API调用时间
- 总处理时间

### 成功率监控
- API调用成功率
- 识别成功率
- 错误类型统计

## 成本控制

### API调用费用
- 按调用次数计费
- 建议设置合理的重试次数
- 监控异常调用

### 云函数费用
- 按执行时间计费
- 建议优化图片大小
- 监控执行时间

## 安全建议

### API Key安全
- 定期轮换API Key
- 不要在客户端暴露API Key
- 使用环境变量管理敏感信息

### 数据安全
- 图片数据不会永久存储
- 所有请求都有详细日志
- 支持数据脱敏处理

---

*最后更新：2024年*
